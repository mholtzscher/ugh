# Show and edit flows
exec ugh --db $WORK/db.sqlite add --status next --due 2026-01-02 --defer 2026-01-10 --waiting-for Alice --notes pack_stuff -P travel -c home -m note:foo Plan trip

exec ugh --db $WORK/db.sqlite show 1
cmp stdout want-show.txt

exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"id":1'
stdout '"done":false'
stdout '"status":"next"'
stdout '"title":"Plan trip"'
stdout '"notes":"pack_stuff"'
stdout '"dueOn":"2026-01-02"'
stdout '"deferUntil":"2026-01-10"'
stdout '"waitingFor":"Alice"'
stdout '"projects":\["travel"\]'
stdout '"contexts":\["home"\]'
stdout '"note":"foo"'

# Edit priority only
exec ugh --db $WORK/db.sqlite edit 1 -p A
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"priority":"A"'
stdout '"title":"Plan trip"'

# Edit title only
exec ugh --db $WORK/db.sqlite edit 1 --title Updated
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"title":"Updated"'
stdout '"priority":"A"'

# Add project (additive)
exec ugh --db $WORK/db.sqlite edit 1 -P work
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"projects":\["travel","work"\]'

# Add context (additive)
exec ugh --db $WORK/db.sqlite edit 1 -c office
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"contexts":\["home","office"\]'

# Add/update metadata
exec ugh --db $WORK/db.sqlite edit 1 -m key:val
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"key":"val"'
stdout '"note":"foo"'

# Update status and waiting-for
exec ugh --db $WORK/db.sqlite edit 1 --status waiting --waiting-for Bob
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"status":"waiting"'
stdout '"waitingFor":"Bob"'

# Clear waiting-for
exec ugh --db $WORK/db.sqlite edit 1 --no-waiting-for
exec ugh --db $WORK/db.sqlite show 1 --json
! stdout '"waitingFor"'

# Clear due and defer
exec ugh --db $WORK/db.sqlite edit 1 --no-due --no-defer
exec ugh --db $WORK/db.sqlite show 1 --json
! stdout '"dueOn"'
! stdout '"deferUntil"'

# Remove project
exec ugh --db $WORK/db.sqlite edit 1 --remove-project travel
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"projects":\["work"\]'

# Remove context
exec ugh --db $WORK/db.sqlite edit 1 --remove-context home
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"contexts":\["office"\]'

# Remove metadata key
exec ugh --db $WORK/db.sqlite edit 1 --remove-meta note
exec ugh --db $WORK/db.sqlite show 1 --json
! stdout '"note"'
stdout '"key":"val"'

# Remove priority
exec ugh --db $WORK/db.sqlite edit 1 --no-priority
exec ugh --db $WORK/db.sqlite show 1 --json
! stdout '"priority"'

# Mark done via edit
exec ugh --db $WORK/db.sqlite edit 1 -x
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"done":true'
stdout '"completedAt"'

# Mark undone via edit
exec ugh --db $WORK/db.sqlite edit 1 --undone
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"done":false'
! stdout '"completedAt"'

# Note: 'ugh edit 1' without flags now opens the editor by default
# This can't be tested in non-interactive mode

# Error: conflicting done/undone
! exec ugh --db $WORK/db.sqlite edit 1 -x --undone
stderr 'cannot use both'

# Error: invalid priority
! exec ugh --db $WORK/db.sqlite edit 1 -p invalid
stderr 'invalid priority'

# Error: invalid meta format
! exec ugh --db $WORK/db.sqlite edit 1 -m badmeta
stderr 'invalid meta format'

# Error: editor flag with field flags
! exec ugh --db $WORK/db.sqlite edit 1 -e -p A
stderr 'cannot combine field flags with --editor'

# Error: non-existent task
! exec ugh --db $WORK/db.sqlite edit 999 -p A
stderr 'no rows'

# Priority normalization (lowercase to uppercase)
exec ugh --db $WORK/db.sqlite edit 1 -p b
exec ugh --db $WORK/db.sqlite show 1 --json
stdout '"priority":"B"'

# Multiple flags at once
exec ugh --db $WORK/db.sqlite add Test multi-edit
exec ugh --db $WORK/db.sqlite edit 2 --status next -p A -P proj1 -P proj2 -c ctx1 --due 2026-01-05 --defer 2026-01-06 --waiting-for Alice --notes note -m key1:val1 -m key2:val2
exec ugh --db $WORK/db.sqlite show 2 --json
stdout '"status":"next"'
stdout '"priority":"A"'
stdout '"projects":\["proj1","proj2"\]'
stdout '"contexts":\["ctx1"\]'
stdout '"dueOn":"2026-01-05"'
stdout '"deferUntil":"2026-01-06"'
stdout '"waitingFor":"Alice"'
stdout '"notes":"note"'
stdout '"key1":"val1"'
stdout '"key2":"val2"'

-- want-show.txt --
1	next	2026-01-02	2026-01-10	Plan trip
